#!/bin/bash
set -e

# Remove the first '--' if pnpm adds it
if [ "$1" = "--" ]; then
  shift
fi

# Detect docker or podman
if command -v docker &> /dev/null; then
  CONTAINER_CMD="docker"
elif command -v podman &> /dev/null; then
  CONTAINER_CMD="podman"
else
  echo "Error: Neither docker nor podman is installed"
  exit 1
fi

# Load test environment variables
set -a
source .env.test
set +a

cleanup_webserver() {
  if command -v lsof &> /dev/null; then
    local pids=$(lsof -ti:${PLAYWRIGHT_WEBSERVER_PORT} 2>/dev/null || true)
    if [ -n "$pids" ]; then
      echo "Killing processes on port ${PLAYWRIGHT_WEBSERVER_PORT}: $pids"
      kill $pids 2>/dev/null || true
      sleep 1
      kill -9 $pids 2>/dev/null || true
    fi
  fi
}

cleanup_containers() {
  local containers=$($CONTAINER_CMD ps -a --filter "name=$TEST_DB_CONTAINER_NAME" --filter "name=$STRIPE_MOCK_CONTAINER_NAME" -q 2>/dev/null || true)

  if [ -n "$containers" ]; then
    echo "Cleaning up lingering test containers..."
    if ! output=$($CONTAINER_CMD compose --env-file .env.test -f docker-compose.test.yml down -v 2>&1); then
      echo "$output"
      return 1
    fi
  fi
}

setup_services() {
  cleanup_webserver
  cleanup_containers

  local output

  if ! output=$($CONTAINER_CMD compose --env-file .env.test -f docker-compose.test.yml up -d 2>&1); then
    echo "$output"
    exit 1
  fi

  SECONDS=0
  until $CONTAINER_CMD compose -f docker-compose.test.yml exec -T postgres-test pg_isready -U "$POSTGRES_USER" > /dev/null 2>&1; do
    if [ $SECONDS -gt 30 ]; then
      echo "Timeout waiting for PostgreSQL to be ready"
      exit 1
    fi
    sleep 1
  done

  SECONDS=0
  until curl -s "$STRIPE_API_BASE" > /dev/null 2>&1; do
    if [ $SECONDS -gt 30 ]; then
      echo "Timeout waiting for Stripe Mock to be ready"
      exit 1
    fi
    sleep 1
  done

  if ! output=$(pnpm db:migrate 2>&1); then
    echo "$output"
    exit 1
  fi
}

teardown_services() {
  cleanup_webserver
  cleanup_containers
}

trap teardown_services EXIT INT TERM
setup_services
pnpm exec playwright test "$@"

// ############################################################################
// ################# General journald logs, excluding the garden services #####
// ############################################################################

loki.source.journal "journal_other" {
  max_age    = "12h"
  forward_to = [loki.write.grafana_cloud_loki.receiver]
  relabel_rules = loki.relabel.journal_other.rules
}

loki.relabel "journal_other" {
  forward_to = []

  // Drop logs from the garden services, as they are handled separately
  rule {
    source_labels = ["__journal__systemd_user_unit"]
    regex         = "always-on-node.service"
    action        = "drop"
  }

  // Drop logs from garden containers (handled by garden_containers)
  rule {
    source_labels = ["__journal_container_name"]
    regex         = ".+"
    action        = "drop"
  }

  // Add some generic labels
  rule {
    source_labels = ["__journal__systemd_unit"]
    target_label  = "systemd_unit"
  }
  rule {
    source_labels = ["__journal__systemd_user_unit"]
    target_label  = "systemd_user_unit"
  }
  rule {
    source_labels = ["__journal_priority_keyword"]
    target_label  = "level"
  }
  rule {
      target_label = "instance"
      replacement = "{{ inventory_hostname }}"
  }
  rule {
      target_label = "job"
      replacement = "journal"
  }
}


// ############################################################################
// ################# Always-on-node service logs ##############################
// ############################################################################

loki.source.journal "garden_always_on_node" {
  max_age    = "12h"
  forward_to = [loki.process.garden_always_on_node.receiver]
  matches    = "_SYSTEMD_USER_UNIT=always-on-node.service"
  labels     = {app = "always-on-node", job = "garden", instance = "{{ inventory_hostname }}"}
}

loki.process "garden_always_on_node" {
  forward_to = [loki.write.grafana_cloud_loki.receiver]
}

// ############################################################################
// ####################### Caddy logs #########################################
// ############################################################################

loki.source.journal "caddy" {
  max_age    = "12h"
  forward_to = [loki.process.caddy.receiver]
  matches    = "_SYSTEMD_UNIT=caddy.service"
  labels     = {app = "caddy", job = "garden", instance = "{{ inventory_hostname }}"}
}

loki.process "caddy" {
  forward_to = [loki.write.grafana_cloud_loki.receiver]

  // Caddy logs are in JSON format by default.
  stage.json {
    expressions = {
      "level" = "",
      "ts" = "",
      "logger" = "",
      "msg" = "",
      "bytes_read" = "",
      "user_id" = "",
      "duration" = "",
      "size" = "",
      "status" = "",
      "request" = "",
      "resp_headers" = "",
    }
  }
}


// ############################################################################
// ################### Cron logs ##############################################
// ############################################################################

loki.source.journal "cron" {
  max_age    = "12h"
  forward_to = [loki.process.cron.receiver]
  matches    = "_SYSTEMD_UNIT=cron.service"
  labels     = {app = "cron", job = "garden", instance = "{{ inventory_hostname }}"}
}

loki.process "cron" {
  forward_to = [loki.write.grafana_cloud_loki.receiver]
}



// ############################################################################
// ######################### Garden Container Logs ############################
// ############################################################################

loki.source.journal "garden_containers" {
  max_age       = "12h"
  forward_to    = [loki.process.garden_containers.receiver]
  relabel_rules = loki.relabel.garden_containers.rules
  labels        = {job = "garden", instance = "{{ inventory_hostname }}"}
}

loki.relabel "garden_containers" {
  forward_to = []

  // 1. Filter: Only keep logs that have CONTAINER_TAG in the expected format
  // and component is radicle-node or radicle-httpd
  rule {
    source_labels = ["__journal_container_tag"]
    regex         = "garden\\|\\|(radicle-node|radicle-httpd)\\|\\|.+"
    action        = "keep"
  }

  // 2. Preserve CONTAINER_TAG as a regular label so it's available in process stage
  rule {
    source_labels = ["__journal_container_tag"]
    target_label  = "container_tag"
  }

  // 3. Extract standard Container Name
  rule {
    source_labels = ["__journal_container_name"]
    target_label  = "container_name"
  }
}

loki.process "garden_containers" {
  forward_to = [loki.write.grafana_cloud_loki.receiver]

  // Parse the tag we see in `journalctl -o verbose`:
  // CONTAINER_TAG=garden||radicle-node||<garden_user>||<node_id>
  stage.regex {
    source     = "container_tag"
    expression = "^(?P<app>[^|]+)\\|\\|(?P<component>[^|]+)\\|\\|(?P<garden_user>[^|]+)\\|\\|(?P<node_id>.+)$"
  }

  // Turn extracted fields into Loki labels
  stage.labels {
    values = {
      app       = "app",
      component = "component",
      garden_user = "garden_user",
      node_id   = "node_id",
    }
  }

  // Drop the container_tag label now that we've extracted what we need
  stage.label_drop {
    values = ["container_tag"]
  }
}


// ############################################################################
// ######################### Metrics Configuration ############################
// ############################################################################


// ############################################################################
// ######################### Container monitoring #############################
// ############################################################################

// Container metrics (via cAdvisor HTTP endpoint)
prometheus.scrape "cadvisor" {
  targets = [
    {
      "__address__" = "localhost:{{ cadvisor_port }}",
      "job"         = "cadvisor",
    },
  ]
  forward_to      = [prometheus.relabel.cadvisor_metrics.receiver]
  scrape_interval = "30s"
}

// ############################################################################
// ######################### Host Monitoring ##################################
// ############################################################################

discovery.relabel "integrations_node_exporter" {
  targets = prometheus.exporter.unix.integrations_node_exporter.targets

  rule {
    target_label = "instance"
    replacement  = "{{ inventory_hostname }}"
  }

  rule {
    target_label = "job"
    replacement = "integrations/node_exporter"
  }
}

prometheus.exporter.unix "integrations_node_exporter" {
  disable_collectors = ["ipvs", "btrfs", "infiniband", "xfs", "zfs"]
  enable_collectors = ["meminfo"]

  filesystem {
    fs_types_exclude     = "^(autofs|binfmt_misc|bpf|cgroup2?|configfs|debugfs|devpts|devtmpfs|tmpfs|fusectl|hugetlbfs|iso9660|mqueue|nsfs|overlay|proc|procfs|pstore|rpc_pipefs|securityfs|selinuxfs|squashfs|sysfs|tracefs)$"
    mount_points_exclude = "^/(dev|proc|run/credentials/.+|sys|var/lib/docker/.+)($|/)"
    mount_timeout        = "5s"
  }

  netclass {
    ignored_devices = "^(veth.*|cali.*|[a-f0-9]{15})$"
  }

  netdev {
    device_exclude = "^(veth.*|cali.*|[a-f0-9]{15})$"
  }
}

prometheus.scrape "integrations_node_exporter" {
  targets    = discovery.relabel.integrations_node_exporter.output
  forward_to = [prometheus.relabel.integrations_node_exporter.receiver]
}

prometheus.relabel "integrations_node_exporter" {
  forward_to = [prometheus.remote_write.metrics_service.receiver]

  rule {
    source_labels = ["__name__"]
    regex         = "up|node_arp_entries|node_boot_time_seconds|node_context_switches_total|node_cpu_seconds_total|node_disk_io_time_seconds_total|node_disk_io_time_weighted_seconds_total|node_disk_read_bytes_total|node_disk_read_time_seconds_total|node_disk_reads_completed_total|node_disk_write_time_seconds_total|node_disk_writes_completed_total|node_disk_written_bytes_total|node_filefd_allocated|node_filefd_maximum|node_filesystem_avail_bytes|node_filesystem_device_error|node_filesystem_files|node_filesystem_files_free|node_filesystem_readonly|node_filesystem_size_bytes|node_intr_total|node_load1|node_load15|node_load5|node_md_disks|node_md_disks_required|node_memory_Active_anon_bytes|node_memory_Active_bytes|node_memory_Active_file_bytes|node_memory_AnonHugePages_bytes|node_memory_AnonPages_bytes|node_memory_Bounce_bytes|node_memory_Buffers_bytes|node_memory_Cached_bytes|node_memory_CommitLimit_bytes|node_memory_Committed_AS_bytes|node_memory_DirectMap1G_bytes|node_memory_DirectMap2M_bytes|node_memory_DirectMap4k_bytes|node_memory_Dirty_bytes|node_memory_HugePages_Free|node_memory_HugePages_Rsvd|node_memory_HugePages_Surp|node_memory_HugePages_Total|node_memory_Hugepagesize_bytes|node_memory_Inactive_anon_bytes|node_memory_Inactive_bytes|node_memory_Inactive_file_bytes|node_memory_Mapped_bytes|node_memory_MemAvailable_bytes|node_memory_MemFree_bytes|node_memory_MemTotal_bytes|node_memory_SReclaimable_bytes|node_memory_SUnreclaim_bytes|node_memory_ShmemHugePages_bytes|node_memory_ShmemPmdMapped_bytes|node_memory_Shmem_bytes|node_memory_Slab_bytes|node_memory_SwapTotal_bytes|node_memory_VmallocChunk_bytes|node_memory_VmallocTotal_bytes|node_memory_VmallocUsed_bytes|node_memory_WritebackTmp_bytes|node_memory_Writeback_bytes|node_netstat_Icmp6_InErrors|node_netstat_Icmp6_InMsgs|node_netstat_Icmp6_OutMsgs|node_netstat_Icmp_InErrors|node_netstat_Icmp_InMsgs|node_netstat_Icmp_OutMsgs|node_netstat_IpExt_InOctets|node_netstat_IpExt_OutOctets|node_netstat_TcpExt_ListenDrops|node_netstat_TcpExt_ListenOverflows|node_netstat_TcpExt_TCPSynRetrans|node_netstat_Tcp_InErrs|node_netstat_Tcp_InSegs|node_netstat_Tcp_OutRsts|node_netstat_Tcp_OutSegs|node_netstat_Tcp_RetransSegs|node_netstat_Udp6_InDatagrams|node_netstat_Udp6_InErrors|node_netstat_Udp6_NoPorts|node_netstat_Udp6_OutDatagrams|node_netstat_Udp6_RcvbufErrors|node_netstat_Udp6_SndbufErrors|node_netstat_UdpLite_InErrors|node_netstat_Udp_InDatagrams|node_netstat_Udp_InErrors|node_netstat_Udp_NoPorts|node_netstat_Udp_OutDatagrams|node_netstat_Udp_RcvbufErrors|node_netstat_Udp_SndbufErrors|node_network_carrier|node_network_info|node_network_mtu_bytes|node_network_receive_bytes_total|node_network_receive_compressed_total|node_network_receive_drop_total|node_network_receive_errs_total|node_network_receive_fifo_total|node_network_receive_multicast_total|node_network_receive_packets_total|node_network_speed_bytes|node_network_transmit_bytes_total|node_network_transmit_compressed_total|node_network_transmit_drop_total|node_network_transmit_errs_total|node_network_transmit_fifo_total|node_network_transmit_multicast_total|node_network_transmit_packets_total|node_network_transmit_queue_length|node_network_up|node_nf_conntrack_entries|node_nf_conntrack_entries_limit|node_os_info|node_sockstat_FRAG6_inuse|node_sockstat_FRAG_inuse|node_sockstat_RAW6_inuse|node_sockstat_RAW_inuse|node_sockstat_TCP6_inuse|node_sockstat_TCP_alloc|node_sockstat_TCP_inuse|node_sockstat_TCP_mem|node_sockstat_TCP_mem_bytes|node_sockstat_TCP_orphan|node_sockstat_TCP_tw|node_sockstat_UDP6_inuse|node_sockstat_UDPLITE6_inuse|node_sockstat_UDPLITE_inuse|node_sockstat_UDP_inuse|node_sockstat_UDP_mem|node_sockstat_UDP_mem_bytes|node_sockstat_sockets_used|node_softnet_dropped_total|node_softnet_processed_total|node_softnet_times_squeezed_total|node_systemd_unit_state|node_textfile_scrape_error|node_time_zone_offset_seconds|node_timex_estimated_error_seconds|node_timex_maxerror_seconds|node_timex_offset_seconds|node_timex_sync_status|node_uname_info|node_vmstat_oom_kill|node_vmstat_pgfault|node_vmstat_pgmajfault|node_vmstat_pgpgin|node_vmstat_pgpgout|node_vmstat_pswpin|node_vmstat_pswpout|process_max_fds|process_open_fds"
    action        = "keep"
  }
}

prometheus.scrape "systemd_exporter" {
  scrape_interval = "15s"

  targets    = [
    {
      "__address__" = "localhost:{{ systemd_exporter_port }}",
      "__metrics_path__" = "/metrics",
      "job"              = "systemd-exporter",
    },
  ]
  forward_to = [prometheus.remote_write.metrics_service.receiver]
}


prometheus.relabel "cadvisor_metrics" {
  forward_to = [prometheus.remote_write.metrics_service.receiver]

  rule {
    source_labels = ["__name__"]
    regex         = "container_cpu_usage_seconds_total|container_memory_working_set_bytes|container_fs_usage_bytes|container_fs_limit_bytes|container_network_receive_bytes_total|container_network_transmit_bytes_total|machine_cpu_cores|machine_memory_bytes|container_last_seen|container_start_time_seconds"
    action        = "keep"
  }
}


// ############################################################################
// ######################### Grafana Cloud Configuration ######################
// ############################################################################

loki.write "grafana_cloud_loki" {
  endpoint {
    url       = "{{ grafana_cloud_loki_url }}"
    basic_auth {
      username = "{{ grafana_cloud_logs_username }}"
      password = "{{ grafana_cloud_api_key }}"
    }
  }
  external_labels = {}
}

prometheus.remote_write "metrics_service" {
  endpoint {
    url = "{{ grafana_cloud_prometheus_url }}"
    basic_auth {
      username = "{{ grafana_cloud_metrics_username }}"
      password = "{{ grafana_cloud_api_key }}"
    }
  }
}

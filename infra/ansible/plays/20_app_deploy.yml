- name: Deploy apps
  hosts: prod
  gather_facts: yes
  become: true
  become_user: "{{ system_username }}"
  vars:
    deploy_date: "{{ ansible_date_time.date }}"
    releases_dir: "{{ app_dir }}/releases"
    release_dir: "{{ releases_dir }}/{{ deploy_date }}_{{ git_commit_hash | default('unknown') }}"
    current_link: "{{ app_dir }}/current"
  tasks:
    - name: Create the environment file
      template:
        src: ../templates/aon_env_file.j2
        dest: "{{ config_dir }}/radicle/always-on-node_env"
        owner: "{{ system_username }}"
        group: "{{ system_username }}"
        mode: "0644"

    - name: Stop the service
      systemd:
        name: always-on-node.service
        state: stopped
        scope: user
      ignore_errors: yes

    - name: Ensure releases directory exists
      file:
        path: "{{ releases_dir }}"
        state: directory
        owner: "{{ system_username }}"
        group: "{{ system_username }}"
        mode: "0755"

    - name: Create release directory
      file:
        path: "{{ release_dir }}"
        state: directory
        owner: "{{ system_username }}"
        group: "{{ system_username }}"
        mode: "0755"

    - name: Upload deployment archive
      copy:
        src: "{{ deploy_archive }}"
        dest: "/tmp/deploy.tar.gz"
        owner: "{{ system_username }}"
        group: "{{ system_username }}"
        mode: "0644"

    - name: Extract deployment archive
      unarchive:
        src: "/tmp/deploy.tar.gz"
        dest: "{{ release_dir }}"
        remote_src: yes
        owner: "{{ system_username }}"
        group: "{{ system_username }}"

    - name: Install production dependencies
      ansible.builtin.shell: export PATH=/usr/local/lib/npm/bin:$PATH && pnpm install --prod --frozen-lockfile
      args:
        chdir: "{{ release_dir }}"

    - name: Update current symlink
      file:
        src: "{{ release_dir }}"
        dest: "{{ current_link }}"
        owner: "{{ system_username }}"
        group: "{{ system_username }}"
        state: link
        force: yes

    - name: Clean up deployment archive
      file:
        path: "/tmp/deploy.tar.gz"
        state: absent

    - name: Clean up old releases (keep last 10)
      shell: |
        cd {{ releases_dir }}
        ls -t | tail -n +11 | xargs -r rm -rf
      args:
        executable: /bin/bash

    - name: Run DB migrations
      ansible.builtin.shell: export PATH=/usr/local/lib/npm/bin:$PATH && pnpm db:migrate
      args:
        chdir: "{{ release_dir }}"

    - name: Create the systemd unit file
      template:
        src: ../templates/aon_systemd_unit.j2
        dest: "{{ config_dir }}/systemd/user/always-on-node.service"
        owner: "{{ system_username }}"
        group: "{{ system_username }}"
        mode: "0644"
      register: systemd_unit

    - name: Reload systemd if unit changed
      systemd:
        daemon_reload: yes
        scope: user
      when: systemd_unit.changed

    - name: Start the service
      systemd:
        name: always-on-node.service
        enabled: yes
        state: started
        scope: user
